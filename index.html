<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIVL 100 - Statics Tutorial Registration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 15px;
        }
        .container {
            max-width: 800px; margin: 0 auto; background: white;
            border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg,#2c3e50,#34495e);
            color: white; padding: 25px 20px; text-align: center;
        }
        .header h1 { font-size: 24px; margin-bottom: 8px; }
        .content { padding: 20px; }
        .capacity-tracker {
            background:#f8f9fa; border-left:4px solid #667eea;
            padding:15px; margin-bottom:20px; border-radius:4px;
        }
        .capacity-tracker h3 { color:#2c3e50; margin-bottom:12px; font-size:18px; }
        .session-counts { margin-top: 12px; font-size: 14px; }
        .session-count-item {
            display:flex; justify-content:space-between;
            padding:8px 0; border-bottom:1px solid #e0e0e0;
        }
        .session-count-item:last-child { border-bottom:none; }
        .session-info {
            background:#f0f4ff; padding:15px; border-radius:6px; margin-bottom:20px;
        }
        .session-info h3 { margin-bottom:12px; color:#2c3e50; font-size:16px; }
        .session-option { margin-bottom:12px; padding:10px; background:white; border-radius:4px; font-size:14px; }
        .session-option strong { color:#667eea; display:block; margin-bottom:4px; }

        .form-group { margin-bottom:20px; }
        label { display:block; margin-bottom:8px; color:#2c3e50; font-weight:600; font-size:15px; }
        .required { color:#e74c3c; }

        input[type="text"], select {
            width:100%; padding:14px; border:2px solid #ddd; border-radius:8px;
            font-size:16px; font-family:inherit; background:white;
        }
        input[type="text"]:focus, select:focus { outline:none; border-color:#667eea; }

        .submit-btn {
            width:100%; padding:16px; background:linear-gradient(135deg,#667eea,#764ba2);
            color:white; border:none; border-radius:8px; font-size:17px; font-weight:600; cursor:pointer;
            font-family:inherit;
        }

        .alert {
            padding:15px; border-radius:6px; margin-bottom:20px; display:none; font-size:15px;
        }
        .alert.success { background:#d4edda; color:#155724; border-left:4px solid #28a745; }
        .alert.error { background:#f8d7da; color:#721c24; border-left:4px solid #dc3545; }

        .registrations-section { margin-top:30px; padding-top:20px; border-top:2px solid #e0e0e0; }
        .admin-buttons { display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; }
        .admin-btn {
            flex:1; min-width:140px; padding:12px; border:none; border-radius:6px;
            font-size:14px; font-weight:600; cursor:pointer; font-family:inherit;
        }
        .export-btn { background:#28a745; color:white; }
        .reset-btn { background:#dc3545; color:white; }

        .registrations-table { overflow-x:auto; }
        table { width:100%; border-collapse:collapse; min-width:550px; font-size:14px; }
        th, td { padding:10px 8px; border-bottom:1px solid #e0e0e0; }
        th { background:#f8f9fa; font-weight:600; color:#2c3e50; }

        .locked-message { text-align:center; padding:40px 20px; color:#721c24; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ðŸ“š CIVL 100 - Statics Tutorial Registration</h1>
        <p>Australian University of Kuwait</p>
    </div>

    <div class="content">

        <div class="capacity-tracker">
            <h3>Registration Capacity</h3>
            <p><strong>Total:</strong> <span id="totalCount">0</span> / 90 students</p>
            <div class="session-counts">
                <div class="session-count-item"><span>Session 1</span><strong id="count1">0/30</strong></div>
                <div class="session-count-item"><span>Session 2</span><strong id="count2">0/30</strong></div>
                <div class="session-count-item"><span>Session 3</span><strong id="count3">0/30</strong></div>
            </div>
        </div>

        <div class="alert" id="alertBox"></div>

        <div id="formSection">
            <div class="session-info">
                <h3>ðŸ“… Available Tutorial Sessions</h3>
                <div class="session-option"><strong>Session 1</strong> Monday, Dec 8 2025 | 9 AM - 11 AM | Bldg 4, TF 04</div>
                <div class="session-option"><strong>Session 2</strong> Monday, Dec 8 2025 | 4 PM - 6 PM | Bldg 4, SF 04</div>
                <div class="session-option"><strong>Session 3</strong> Tuesday, Dec 9 2025 | 12 PM - 2 PM | Bldg 3B, GF 03</div>
            </div>

            <div class="form-group">
                <label>Full Name <span class="required">*</span></label>
                <input type="text" id="studentName" placeholder="Enter your full name">
            </div>

            <div class="form-group">
                <label>Student ID <span class="required">*</span></label>
                <input type="text" id="studentId" placeholder="Enter numeric Student ID">
            </div>

            <div class="form-group">
                <label>Preferred Session <span class="required">*</span></label>
                <select id="sessionSelect">
                    <option value="">-- Select a session --</option>
                    <option value="Session1">Session 1 - Mon, Dec 8 2025 | 9 AM - 11 AM</option>
                    <option value="Session2">Session 2 - Mon, Dec 8 2025 | 4 PM - 6 PM</option>
                    <option value="Session3">Session 3 - Tue, Dec 9 2025 | 12 PM - 2 PM</option>
                </select>
            </div>

            <button class="submit-btn" id="registerBtn">Register for Tutorial</button>
        </div>

        <div id="lockedSection" style="display:none;">
            <div class="locked-message">
                <h2>ðŸ”’ Registration Closed</h2>
                <p>All sessions are full.</p>
            </div>
        </div>

        <div class="registrations-section">
            <h3>ðŸ“Š Registration Records</h3>
            <div class="admin-buttons">
                <button class="admin-btn export-btn" id="exportBtn">ðŸ“¥ Export CSV</button>
                <button class="admin-btn reset-btn" id="resetBtn">ðŸ”„ Reset All</button>
            </div>

            <div class="registrations-table">
                <table>
                    <thead><tr><th>#</th><th>Name</th><th>Student ID</th><th>Session</th><th>Time</th></tr></thead>
                    <tbody id="tableBody">
                        <tr><td colspan="5" style="text-align:center;color:#999;">No registrations yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>


<!-- ======================  SCRIPT  ====================== -->

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyjP6WymcUtJSyeXoB03ArieXLYZFukH8fJ6HoHUyYEt21cgIF3Pt2RQc5_au_VNyVH/exec";

    const MAX_PER_SESSION = 30;

    const sessions = {
        Session1: 'Mon, Dec 8 2025 | 9 AM - 11 AM | Bldg 4, TF 04',
        Session2: 'Mon, Dec 8 2025 | 4 PM - 6 PM | Bldg 4, SF 04',
        Session3: 'Tue, Dec 9 2025 | 12 PM - 2 PM | Bldg 3B, GF 03'
    };

    let registrations = [];
    let counts = { Session1:0, Session2:0, Session3:0 };

    // Allow only digits inside Student ID
    document.getElementById("studentId").addEventListener("input", function () {
        this.value = this.value.replace(/\D/g, "");
    });

    async function fetchData() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            registrations = data.registrations || [];
            counts = data.counts || {Session1:0,Session2:0,Session3:0};
            updateUI();
        } catch (e) { console.error(e); }
    }

    function updateUI() {
        document.getElementById("totalCount").textContent = registrations.length;
        document.getElementById("count1").textContent = `${counts.Session1}/30`;
        document.getElementById("count2").textContent = `${counts.Session2}/30`;
        document.getElementById("count3").textContent = `${counts.Session3}/30`;

        const tbody = document.getElementById("tableBody");
        if (registrations.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#999;">No registrations yet</td></tr>`;
        } else {
            tbody.innerHTML = registrations
                .map((r,i)=>`
                    <tr>
                        <td>${i+1}</td>
                        <td>${r.name}</td>
                        <td>${r.studentId}</td>
                        <td>${sessions[r.session]}</td>
                        <td>${r.time}</td>
                    </tr>
                `)
                .join("");
        }

        const select = document.getElementById("sessionSelect");
        select.options[1].disabled = counts.Session1 >= MAX_PER_SESSION;
        select.options[2].disabled = counts.Session2 >= MAX_PER_SESSION;
        select.options[3].disabled = counts.Session3 >= MAX_PER_SESSION;

        select.options[1].text =
            counts.Session1 >= MAX_PER_SESSION ? "Session 1 - FULL" : "Session 1 - " + sessions.Session1;
        select.options[2].text =
            counts.Session2 >= MAX_PER_SESSION ? "Session 2 - FULL" : "Session 2 - " + sessions.Session2;
        select.options[3].text =
            counts.Session3 >= MAX_PER_SESSION ? "Session 3 - FULL" : "Session 3 - " + sessions.Session3;

        if (counts.Session1 >= 30 && counts.Session2 >= 30 && counts.Session3 >= 30) {
            document.getElementById("formSection").style.display = "none";
            document.getElementById("lockedSection").style.display = "block";
        }
    }

    function showMsg(msg, type) {
        const box = document.getElementById("alertBox");
        box.textContent = msg;
        box.className = "alert " + type;
        box.style.display = "block";
        setTimeout(()=>box.style.display="none", 4000);
    }

    document.getElementById("registerBtn").addEventListener("click", async function(e){
        e.preventDefault();

        const name = document.getElementById("studentName").value.trim();
        const studentId = document.getElementById("studentId").value.trim();
        const session = document.getElementById("sessionSelect").value;

        if (!name) return showMsg("Please enter your name", "error");
        if (!studentId) return showMsg("Please enter your Student ID", "error");
        if (!/^\d+$/.test(studentId)) return showMsg("Student ID must be numbers only", "error");
        if (!session) return showMsg("Please select a session", "error");

        await fetchData();

        // BULLETPROOF duplicate check
        const exists = registrations.some(r => {
            const stored = r.studentId;
            const storedId = stored == null ? "" : String(stored).trim();
            return storedId === studentId.trim();
        });
        if (exists) return showMsg("âŒ This Student ID is already registered!", "error");

        if ((counts[session] || 0) >= 30)
            return showMsg("Session is already full", "error");

        const payload = {
            name, studentId, session,
            sessionTime: sessions[session] || ""
        };

        try {
            await fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });

            showMsg("âœ… Registration successful!", "success");
            document.getElementById("studentName").value="";
            document.getElementById("studentId").value="";
            document.getElementById("sessionSelect").value="";

            setTimeout(fetchData, 800);
        } catch (err) {
            console.error(err);
            showMsg("Error submitting registration", "error");
        }
    });

    document.getElementById("exportBtn").onclick = () =>
        alert("Export via Google Sheets â†’ File â†’ Download â†’ CSV");

    document.getElementById("resetBtn").onclick = () =>
        alert("To reset, delete all rows EXCEPT header row in the Google Sheet.");

    fetchData();
</script>

</body>
</html>
